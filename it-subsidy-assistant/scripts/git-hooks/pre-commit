#!/bin/sh
# Git pre-commit hook - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯

set -e

echo "ğŸ” Pre-commit checks starting..."

# 1. Lint check
echo "ğŸ“ Running lint checks..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Lint check failed. Please fix the issues and try again."
  exit 1
fi

# 2. Type check
echo "ğŸ” Running type checks..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type check failed. Please fix the issues and try again."
  exit 1
fi

# 3. Unit tests
echo "ğŸ§ª Running unit tests..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed. Please fix the issues and try again."
  exit 1
fi

# 4. Security checks
echo "ğŸ”’ Running security checks..."

# Check for secrets in code
echo "  ğŸ” Scanning for secrets..."
if command -v gitleaks &> /dev/null; then
  gitleaks detect --source . --verbose
  if [ $? -ne 0 ]; then
    echo "âŒ Potential secrets detected. Please remove them and try again."
    exit 1
  fi
fi

# Check for hardcoded passwords/keys
echo "  ğŸ” Checking for hardcoded credentials..."
if grep -r -E "(password|secret|key)\s*=\s*['\"][^'\"]+['\"]" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" src/; then
  echo "âŒ Hardcoded credentials detected. Please use environment variables."
  exit 1
fi

# Check for console.log in production code
echo "  ğŸ” Checking for console.log statements..."
if grep -r "console\.log" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" src/; then
  echo "âš ï¸  Console.log statements found. Consider removing them for production."
fi

# 5. Dependency vulnerability check
echo "ğŸ” Checking dependencies for vulnerabilities..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo "âŒ High-severity vulnerabilities found. Please fix them and try again."
  exit 1
fi

# 6. Format check
echo "ğŸ’… Checking code formatting..."
npx prettier --check src/
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found. Running auto-fix..."
  npx prettier --write src/
  echo "âœ… Code formatted. Please add the changes and commit again."
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
exit 0