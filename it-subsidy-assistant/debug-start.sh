#!/bin/bash

# ãƒ‡ãƒãƒƒã‚°ç”¨èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

echo "ðŸ” ITè£œåŠ©é‡‘ã‚¢ã‚·ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã®ãƒ‡ãƒãƒƒã‚°èµ·å‹•ã‚’é–‹å§‹ã—ã¾ã™..."

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿å­˜
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒãƒƒã‚°
echo ""
echo "ðŸ“¦ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒãƒƒã‚°..."
cd "$SCRIPT_DIR/backend"

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
echo "ðŸ”Ž ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
if [ -f .env ]; then
    echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
    # å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    source .env
    if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ] || [ -z "$JWT_SECRET" ]; then
        echo "âŒ å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "   ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã—ã¦ãã ã•ã„:"
        echo "   - SUPABASE_URL"
        echo "   - SUPABASE_ANON_KEY"
        echo "   - JWT_SECRET"
        exit 1
    fi
else
    echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    exit 1
fi

# ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¥ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
    npm install
fi

# TypeScriptã®ãƒ‘ã‚¹è¨­å®š
export NODE_OPTIONS="-r tsconfig-paths/register"

echo ""
echo "ðŸš€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
echo "   ãƒãƒ¼ãƒˆ: 3001"
echo "   ç’°å¢ƒ: development"
echo ""

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•ï¼ˆãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¦ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼‰
npm run dev &
BACKEND_PID=$!

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ã‚’å¾…ã¤
echo "â³ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™..."
sleep 5

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®çŠ¶æ…‹ç¢ºèª
if kill -0 $BACKEND_PID 2>/dev/null; then
    echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
    
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    echo "ðŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
    curl -s http://localhost:3001/health > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒæ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™"
        echo ""
        curl http://localhost:3001/health | python3 -m json.tool 2>/dev/null || curl http://localhost:3001/health
        echo ""
    else
        echo "âš ï¸  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã«æŽ¥ç¶šã§ãã¾ã›ã‚“"
    fi
else
    echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
    echo "   è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    exit 1
fi

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®èµ·å‹•
echo ""
echo "ðŸŽ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
cd "$SCRIPT_DIR/frontend"

# ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¥ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
    npm install
fi

echo ""
echo "âœ… èµ·å‹•æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ"
echo ""
echo "ðŸ“Œ ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±:"
echo "   ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:3000"
echo "   ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: http://localhost:3001"
echo "   APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: http://localhost:3001/health"
echo ""
echo "ðŸ›‘ çµ‚äº†ã™ã‚‹ã«ã¯ Ctrl+C ã‚’æŠ¼ã—ã¦ãã ã•ã„"
echo ""

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
npm run dev

# çµ‚äº†æ™‚ã®å‡¦ç†
trap "echo ''; echo 'â¹ï¸  ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...'; kill $BACKEND_PID 2>/dev/null; exit" INT TERM